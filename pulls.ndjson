{"pull_number":"1233","title":"LoRA: Optimise LoKr at runtime","body":"Tested with https://civitai.green/models/344873/plana-blue-archivelokr\r\n\r\n## Hip (ROCm 6.2)\r\n### Master: \r\n\r\n| | 512x512 | 1024x1024 | 1024x1536 |\r\n| -- | -- | -- | -- |\r\n| Unet compute buffer | 3 295.83MB | 3 993.52MB | 4 860.33MB |\r\n| Average time per step | 0.89s | 2.14s | 3.2s |\r\n\r\n### PR: \r\n\r\n| | 512x512 | 1024x1024 | 1024x1536 |\r\n| -- | -- | -- | -- |\r\n| Unet compute buffer | 137.05MB | 830.86MB | 1 701.55MB |\r\n| Average time per step | 1.3s | 4.8s | 7.44s |\r\n\r\n## Vulkan (AMD propreitary driver):\r\n###Master: \r\n\r\n| | 512x512 | 1024x1024 | 1024x1536 |\r\n| -- | -- | -- | -- |\r\n| Unet compute buffer | 3 363.80MB | 4056.49MB | 4986.61MB |\r\n| Average time per step | 1.02s | 2.38s | 3.57s |\r\n\r\n### PR: \r\n\r\n| | 512x512 | 1024x1024 | 1024x1536 |\r\n| -- | -- | -- | -- |\r\n| Unet compute buffer | 137.05MB |  830.86MB | 1 746.55MB |\r\n| Average time per step | 0.92s | 2.98s | 4.5s |\r\n\r\nTLDR: significant VRAM savings across the board. Somehow a big performance hit across all resolutions on ROCm backend (that needs some more investigation), Vulkan backend going faster at smaller resolutions, but slower at high res. \r\n\r\n\r\n### EDIT:\r\n Not long after doing these measurments I found a way to massively reduce the performance gap (with the same compute buffer size). It's now consistently better than master on Vulkan, \r\n I'm too lazy to do the all tests again for now, but for example,1024x1536 now takes 3.84s per step on ROCm, and 3.07s on Vulkan","pull_head_sha":"f7d53b6551ea9b29c5f86ba0eacbee0d55feca9a","loci_pr_branch":"loci/pr-1233-lokr-forward","short_merge_base":"f957fa3","loci_main_branch":"loci/main-f957fa3"}
